const proxyName = "ä»£ç†æ¨¡å¼";

function main(params) {
    if (!params.proxies) return params;
    overwriteBasicOptions(params);
    overwriteSniffer(params);
    overwriteProxyGroups(params);
    overwriteRules(params);
    overwriteDns(params);
    overwriteTunnel(params);
    return params;
}

// è¦†å†™Basic Options
function overwriteBasicOptions(params) {
    const otherOptions = {
        "mixed-port": 7890,
        "allow-lan": true,
        "unified-delay": true,
        "tcp-concurrent": true,
        "geodata-mode": true,
        "fakeind-process-mode": "strict",
        "global-client-fingerprint": "chrome",
        profile: {
            "store-selected": true,
            "store-fake-ip": true,
        },
        ipv6: true,
        mode: "rule",
        "skip-auth-prefixes": ["127.0.0.1/32"],
        "lan-allowed-ips": ["0.0.0.0/0", "::/0"],
    };
    Object.keys(otherOptions).forEach((key) => {
        params[key] = otherOptions[key];
    });
}

function overwriteSniffer(params) {
    const snifferConfig = {
        enable: true,
        "force-dns-mapping": true,
        "parse-pure-ip": true,
        "override-destination": false,

        sniff: {
            HTTP: {
                ports: ["80", "443"],
                "override-destination": false,
            },

            TLS: {
                ports: ["443"],
            },
        },

        // è·³è¿‡å—…æŽ¢ç»“æžœ
        "skip-domain": ["+.push.apple.com"],

        "skip-dst-address": [
            "91.105.192.0/23",
            "91.108.4.0/22",
            "91.108.8.0/21",
            "91.108.16.0/21",
            "91.108.56.0/22",
            "95.161.64.0/20",
            "149.154.160.0/20",
            "185.76.151.0/24",
            "2001:67c:4e8::/48",
            "2001:b28:f23c::/47",
            "2001:b28:f23f::/48",
            "2a0a:f280:203::/48",
        ]
    };

    params["sniffer"] = snifferConfig;
}

// è¦†å†™ä»£ç†ç»„
function overwriteProxyGroups(params) {
    // æ·»åŠ è‡ªç”¨ä»£ç†
    params.proxies
        .push
        //  { name: '1 - é¦™æ¸¯ - ç¤ºä¾‹ ', type: *, server: **, port: *, cipher: **, password: **, udp: true }
        ();
    // è‡ªåŠ¨é€‰æ‹©ä»£ç†ç»„ï¼ŒæŒ‰åœ°åŒºåˆ†ç»„é€‰å»¶è¿Ÿæœ€ä½Ž
    const countryRegions = [
        {
            code: "HK",
            name: "ðŸ‡­ðŸ‡° é¦™æ¸¯",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/hk.svg",
            regex: /(é¦™æ¸¯|HK|Hong Kong|ðŸ‡­ðŸ‡°)/i,
        },
        {
            code: "TW",
            name: "ðŸ‡¹ðŸ‡¼ å°æ¹¾",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/tw.svg",
            regex: /(å°æ¹¾|TW|Taiwan|ðŸ‡¹ðŸ‡¼)/i,
        },
        {
            code: "SG",
            name: "ðŸ‡¸ðŸ‡¬ æ–°åŠ å¡",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/sg.svg",
            regex: /(æ–°åŠ å¡|ç‹®åŸŽ|SG|Singapore|ðŸ‡¸ðŸ‡¬)/i,
        },
        {
            code: "AR",
            name: "ðŸ‡¦ðŸ‡· é˜¿æ ¹å»·",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ar.svg",
            regex: /(é˜¿æ ¹å»·|AR|Argentina|ðŸ‡¦ðŸ‡·)/i,
        },
        {
            code: "JP",
            name: "ðŸ‡¯ðŸ‡µ æ—¥æœ¬",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/jp.svg",
            regex: /(æ—¥æœ¬|JP|Japan|ðŸ‡¯ðŸ‡µ)/i,
        },
        {
            code: "US",
            name: "ðŸ‡ºðŸ‡¸ ç¾Žå›½",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/us.svg",
            regex: /(ç¾Žå›½|US|USA|United States|America|ðŸ‡ºðŸ‡¸)/i,
        },
        {
            code: "DE",
            name: "ðŸ‡©ðŸ‡ª å¾·å›½",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/de.svg",
            regex: /(å¾·å›½|DE|Germany|ðŸ‡©ðŸ‡ª)/i,
        },
        {
            code: "KR",
            name: "ðŸ‡°ðŸ‡· éŸ©å›½",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/kr.svg",
            regex: /(éŸ©å›½|KR|Korea|South Korea|ðŸ‡°ðŸ‡·)/i,
        },
        {
            code: "UK",
            name: "ðŸ‡¬ðŸ‡§ è‹±å›½",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/gb.svg",
            regex: /(è‹±å›½|UK|United Kingdom|Britain|Great Britain|ðŸ‡¬ðŸ‡§)/i,
        },
        {
            code: "CA",
            name: "ðŸ‡¨ðŸ‡¦ åŠ æ‹¿å¤§",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ca.svg",
            regex: /(åŠ æ‹¿å¤§|CA|Canada|ðŸ‡¨ðŸ‡¦)/i,
        },
        {
            code: "AU",
            name: "ðŸ‡¦ðŸ‡º æ¾³å¤§åˆ©äºš",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/au.svg",
            regex: /(æ¾³å¤§åˆ©äºš|AU|Australia|ðŸ‡¦ðŸ‡º)/i,
        },
        {
            code: "ES",
            name: "ðŸ‡ªðŸ‡¸ è¥¿ç­ç‰™",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/es.svg",
            regex: /\b(è¥¿ç­ç‰™|ES|Spain|ðŸ‡ªðŸ‡¸)\b/i,
        },
        {
            code: "NL",
            name: "ðŸ‡³ðŸ‡± è·å…°",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/nl.svg",
            regex: /\b(è·å…°|NL|Netherlands|ðŸ‡³ðŸ‡±)\b/i,
        },
        {
            code: "TR",
            name: "ðŸ‡¹ðŸ‡· åœŸè€³å…¶",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/tr.svg",
            regex: /(åœŸè€³å…¶|TR|Turkey|ðŸ‡¹ðŸ‡·)/i,
        },
        {
            code: "RU",
            name: "ðŸ‡·ðŸ‡º ä¿„ç½—æ–¯",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ru.svg",
            regex: /(ä¿„ç½—æ–¯|RU|Russia|ðŸ‡·ðŸ‡º)/i,
        },
        {
            code: "IN",
            name: "ðŸ‡®ðŸ‡³ å°åº¦",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/in.svg",
            regex: /\b(å°åº¦|IN|India|ðŸ‡®ðŸ‡³)\b/i,
        },
        {
            code: "BR",
            name: "ðŸ‡§ðŸ‡· å·´è¥¿",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/br.svg",
            regex: /(å·´è¥¿|BR|Brazil|ðŸ‡§ðŸ‡·)/i,
        },
        {
            code: "IT",
            name: "ðŸ‡®ðŸ‡¹ æ„å¤§åˆ©",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/it.svg",
            regex: /(æ„å¤§åˆ©|IT|Italy|ðŸ‡®ðŸ‡¹)/i,
        },
        {
            code: "CH",
            name: "ðŸ‡¨ðŸ‡­ ç‘žå£«",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/ch.svg",
            regex: /(ç‘žå£«|CH|Switzerland|ðŸ‡¨ðŸ‡­)/i,
        },
        {
            code: "SE",
            name: "ðŸ‡¸ðŸ‡ª ç‘žå…¸",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/se.svg",
            regex: /(ç‘žå…¸|SE|Sweden|ðŸ‡¸ðŸ‡ª)/i,
        },
        {
            code: "NO",
            name: "ðŸ‡³ðŸ‡´ æŒªå¨",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/no.svg",
            regex: /(æŒªå¨|NO|Norway|ðŸ‡³ðŸ‡´)/i,
        },
        {
            name: "å…¶å®ƒ",
            regex: /(?!.*(?: å‰©ä½™ | åˆ°æœŸ | ä¸»é¡µ | å®˜ç½‘ | æ¸¸æˆ | å…³æ³¨))(.*)/,
        },
    ];

    // æ‰€æœ‰ä»£ç†
    // æ‰€æœ‰åœ°åŒº
    const allRegex =
        /^(?!.*(?:è‡ªåŠ¨|æ•…éšœ|æµé‡|å®˜ç½‘|å¥—é¤|æœºåœº|è®¢é˜…|å¹´|æœˆ|å¤±è”|é¢‘é“|Traffic|Expire)).*$/;
    const allProxies = getProxiesByRegexOne(params, allRegex);
    // const allProxies = params["proxies"].map((e) => e.name);

    const availableCountryCodes = new Set();
    const otherProxies = [];
    for (const proxy of params["proxies"]) {
        let found = false;
        for (const region of countryRegions) {
            if (region.regex.test(proxy.name)) {
                availableCountryCodes.add(region.name);
                found = true;
                break;
            }
        }
        if (!found) {
            otherProxies.push(proxy.name);
        }
    }

    const autoProxyGroupRegexs = countryRegions
        .filter((region) => availableCountryCodes.has(region.name))
        .map((region) => ({
            name: `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
            regex: region.regex,
        }));

    const autoProxyGroups = autoProxyGroupRegexs
        .map((item) => ({
            name: item.name,
            type: "fallback",
            url: "http://www.gstatic.com/generate_204",
            interval: 300,
            tolerance: 50,
            proxies: getProxiesByRegex(params, item.regex),
            hidden: true,
        }))
        .filter((item) => item.proxies.length > 0);

    const manualProxyGroupsConfig = countryRegions
        .filter((region) => availableCountryCodes.has(region.name))
        .map((region) => ({
            name: `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
            type: "select",
            proxies: getManualProxiesByRegex(params, region.regex),
            icon: region.icon,
            hidden: false,
        }))
        .filter((item) => item.proxies.length > 0);

    const groups = [
        {
            name: proxyName,
            type: "select",
            url: "http://www.gstatic.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg",
            proxies: [
                "å»¶è¿Ÿä¼˜é€‰",
                "æ•…éšœè½¬ç§»",
                "æ‰‹åŠ¨é€‰æ‹©",
                "è´Ÿè½½å‡è¡¡ (æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡ (è½®è¯¢)",
                "DIRECT",
            ],
        },
        {
            name: "å»¶è¿Ÿä¼˜é€‰",
            type: "url-test",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg",
            "exclude-filter": "è‡ªåŠ¨é€‰æ‹©|æ‰‹åŠ¨é€‰æ‹©",
            proxies: allProxies.length > 0 ? allProxies : ["DIRECT"],
            hidden: true,
        },
        {
            name: "æ•…éšœè½¬ç§»",
            type: "fallback",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/ambulance.svg",
            "exclude-filter": "è‡ªåŠ¨é€‰æ‹©|æ‰‹åŠ¨é€‰æ‹©",
            proxies: allProxies.length > 0 ? allProxies : ["DIRECT"],
            hidden: true,
        },
        {
            name: "æ‰‹åŠ¨é€‰æ‹©",
            type: "select",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg",
            proxies: [
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
            ],
        },
        {
            name: "è´Ÿè½½å‡è¡¡ (æ•£åˆ—)",
            type: "load-balance",
            url: "http://www.gstatic.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/balance.svg",
            interval: 300,
            "max-failed-times": 3,
            strategy: "consistent-hashing",
            lazy: true,
            "exclude-filter": "è‡ªåŠ¨é€‰æ‹©|æ‰‹åŠ¨é€‰æ‹©",
            proxies: allProxies.length > 0 ? allProxies : ["DIRECT"],
            hidden: true,
        },
        {
            name: "è´Ÿè½½å‡è¡¡ (è½®è¯¢)",
            type: "load-balance",
            url: "http://www.gstatic.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/merry_go.svg",
            interval: 300,
            "max-failed-times": 3,
            "exclude-filter": "è‡ªåŠ¨é€‰æ‹©|æ‰‹åŠ¨é€‰æ‹©",
            strategy: "round-robin",
            lazy: true,
            proxies: allProxies.length > 0 ? allProxies : ["DIRECT"],
            hidden: true,
        },
        {
            name: "ç”µæŠ¥æ¶ˆæ¯",
            type: "select",
            proxies: [
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
                "DIRECT",
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg",
        },
        {
            name: "AI",
            type: "select",
            proxies: [
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
                "DIRECT",
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/chatgpt.svg",
        },
        {
            name: "æµåª’ä½“",
            type: "select",
            proxies: [
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
                "DIRECT",
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/youtube.svg",
        },
        {
            name: "è‹¹æžœæœåŠ¡",
            type: "select",
            proxies: [
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
                "DIRECT"  // æ–°å¢žDIRECTé€‰é¡¹
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/apple.svg",
        },
        {
            name: "å¾®è½¯æœåŠ¡",
            type: "select",
            proxies: [
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
                "DIRECT",
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/microsoft.svg",
        },
        {
            name: "GoogleFCM",
            type: "select",
            proxies: [
                "DIRECT",
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg",
        },
        {
            name: "Steamåœ°åŒº",
            type: "select",
            proxies: [
                "DIRECT",
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
            ],
            // "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/steam.svg",
        },
        {
            name: "Emby",
            type: "select",
            proxies: [
                "DIRECT",
                proxyName,
                ...countryRegions
                    .filter((region) => availableCountryCodes.has(region.name))
                    .flatMap((region) => [
                        `${region.name} - è‡ªåŠ¨é€‰æ‹©`,
                        `${region.name} - æ‰‹åŠ¨é€‰æ‹©`,
                    ]),
            ],
            // "include-all": true,
            icon: "https://cdnjs.cloudflare.com/ajax/libs/simple-icons/2.19.0/emby.svg",
        },
        {
            name: "æ¼ç½‘ä¹‹é±¼",
            type: "select",
            proxies: ["DIRECT", proxyName],
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg",
        },
    ];

    autoProxyGroups.length &&
        groups[2].proxies.unshift(...autoProxyGroups.map((item) => item.name));
    groups.push(...autoProxyGroups);
    groups.push(...manualProxyGroupsConfig);
    params["proxy-groups"] = groups;
}

// ä¿®æ”¹è§„åˆ™
function overwriteRules(params) {
    const customRules = [
        // åœ¨æ­¤æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼Œä¼˜å…ˆçº§æ¬¡äºŽadã€‚ä¾‹å­ï¼š
        // "DOMAIN,baidu.com,DIRECT",
    ];

    // å¹¿å‘Šæ‹¦æˆª / éšç§ä¿æŠ¤ / Malware æ‹¦æˆª / Phiishing æ‹¦æˆª
    const adNonipRules = [
        "RULE-SET,Reject_no_ip,REJECT",
        "RULE-SET,Reject_domainset,REJECT",
        "RULE-SET,Reject_no_ip_drop,REJECT-DROP",
        "RULE-SET,Reject_no_ip_no_drop,REJECT",
        "RULE-SET,AdobeActivation1,REJECT", // Adobeå±è”½è§„åˆ™é›†
        "RULE-SET,AdobeActivation2,REJECT", // Adobeå±è”½è§„åˆ™é›†
    ];

    const nonipRules = [
        // ä¸ªäººé‡åˆ°éœ€è¦ä»£ç†çš„åŸŸå(æ¯”è¾ƒç‰¹æ®Š)
        "RULE-SET,CustomProxy_no_ip," + proxyName,

        // GoolgeFCM æŽ¨é€
        "RULE-SET,GoogleFCM_no_ip,GoogleFCM",

        // ç½‘æ˜“äº‘éŸ³ä¹
        "RULE-SET,NetEaseMusic_no_ip,DIRECT",

        // Steam åœ°åŒº
        "RULE-SET,SteamRegion_no_ip,Steamåœ°åŒº",

        // SteamCN
        "RULE-SET,SteamCN_no_ip,DIRECT",
        // Steam
        "RULE-SET,Steam_no_ip," + proxyName,

        /**
         * åŒ…å«æ‰€æœ‰å¸¸è§é™æ€èµ„æº CDN åŸŸåã€å¯¹è±¡å­˜å‚¨åŸŸå
         * å¦‚æžœä½ æ­£åœ¨ä½¿ç”¨å•†ä¸šæ€§è´¨çš„å…¬å…±ä»£ç†æœåŠ¡ã€ä¸”ä½ çš„æœåŠ¡å•†æä¾›æŒ‰ä½Žå€çŽ‡ç»“ç®—æµé‡æ¶ˆè€—çš„èŠ‚ç‚¹ï¼Œå¯ä½¿ç”¨ä¸Šè¿°è§„åˆ™ç»„å°†æµé‡åˆ†é…ç»™è¿™éƒ¨åˆ†èŠ‚ç‚¹
         */
        "RULE-SET,CDN_domainset," + proxyName,
        "RULE-SET,CDN_no_ip," + proxyName,

        // æµåª’ä½“åŸŸå
        /**
         * åŒ…å«
         * 4gtvã€AbemaTVã€All4ã€Amazon Prime Videoã€Apple TVã€Apple Music TVã€Bahamutã€BBCã€Bilibili Intlã€
         * DAZNã€Deezerã€Disney+ã€Discovery+ã€DMMã€encoreTVBã€Fox Nowã€Fox+ã€HBO GO/Now/Max/Asiaã€Huluã€HWTVã€
         * JOOXã€Jwplayerã€KKBOXã€KKTVã€Line TVã€Naver TVã€myTV Superã€Netflixã€niconicoã€Now Eã€Paramount+ã€PBSã€Peacockã€Pandoraã€PBSã€Pornhubã€SoundCloudã€
         * PBSã€Spotifyã€TaiwanGoodã€Tiktok Intlã€Twitchã€ViuTVã€ShowTimeã€iQiYi Globalã€Himalaya Podcastã€Overcastã€WeTV
         */
        "RULE-SET,Stream_no_ip,æµåª’ä½“",
        "RULE-SET,Emby_no_ip,Emby",

        // tg æ¶ˆæ¯
        /**
         * æŽ¨èä»…ä½¿ç”¨ IP CIDR è§„åˆ™ã€‚IP CIDR è§„åˆ™æ•°æ®å®Œå…¨æ¥è‡ª Telegram å®˜æ–¹å‘å¸ƒçš„ CIDR åˆ—è¡¨ï¼Œä¸åŒ…å« Telegram å°šæœªå¯ç”¨çš„ CDNã€æ•°æ®ä¸­å¿ƒçš„ IPã€‚
         * ASN è§„åˆ™ä»…é€‚åˆä½œä¸ºè¡¥å……ï¼›æ­é…éžå®˜æ–¹ MaxMind GeoLite æ•°æ®åº“ï¼ˆä¾‹å¦‚ GeoIP2-CNï¼‰ä½¿ç”¨æ—¶ä¼šå½±å“åŒ¹é…ã€‚
         */
        "RULE-SET,Telegram_no_ip,ç”µæŠ¥æ¶ˆæ¯",

        // äº‘ä¸Šè´µå·žï¼ˆCNï¼‰çš„è‹¹æžœ CDN æ— ç‰¹æ®Šéœ€æ±‚ç›´è¿žå³å¯
        "RULE-SET,AppleCDN_no_ip,DIRECT",
        // è‹¹æžœ CN åŸŸå
        "RULE-SET,AppleCN_no_ip,DIRECT",

        // Microsoft ä¸­å›½ CDN
        "RULE-SET,MicrosoftCDN_no_ip,DIRECT",

        // è½¯ä»¶æ›´æ–°ã€æ“ä½œç³»ç»Ÿç­‰å¤§æ–‡ä»¶ä¸‹è½½
        /**
         * è¿™éƒ¨åˆ†åŸŸåå¯èƒ½åŒ…å« Microsoft å’Œ Apple çš„å›½å†… CDN èŠ‚ç‚¹
         * å¦‚æžœä½ è®¾ç½®äº†å‰é¢çš„Microsoft å’Œ Apple çš„å›½å†… CDN èŠ‚ç‚¹ä¸ºç›´è¿žï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§è¿™éƒ¨åˆ†CDNä¸ä¼šè¢«ä»£ç†ï¼Œè¯·æ”¾å¿ƒ
         */
        "RULE-SET,Download_domainset," + proxyName,
        "RULE-SET,Download_no_ip," + proxyName,

        // è‹¹æžœéœ€è¦ä»£ç†çš„åŸŸå
        "RULE-SET,Apple_no_ip,è‹¹æžœæœåŠ¡",

        // å¾®è½¯éœ€è¦ä»£ç†åŸŸå
        "RULE-SET,Microsoft_no_ip,å¾®è½¯æœåŠ¡",

        // OpenAI è§„åˆ™
        "DOMAIN,browser-intake-datadoghq.com,AI",
        "DOMAIN,chat.openai.com.cdn.cloudflare.net,AI",
        "DOMAIN,openai-api.arkoselabs.com,AI",
        "DOMAIN,openaicom-api-bdcpf8c6d2e9atf6.z01.azurefd.net,AI",
        "DOMAIN,openaicomproductionae4b.blob.core.windows.net,AI",
        "DOMAIN,production-openaicom-storage.azureedge.net,AI",
        "DOMAIN,static.cloudflareinsights.com,AI",
        "DOMAIN-SUFFIX,ai.com,AI",
        "DOMAIN-SUFFIX,algolia.net,AI",
        "DOMAIN-SUFFIX,api.statsig.com,AI",
        "DOMAIN-SUFFIX,auth0.com,AI",
        "DOMAIN-SUFFIX,chatgpt.com,AI",
        "DOMAIN-SUFFIX,chatgpt.livekit.cloud,AI",
        "DOMAIN-SUFFIX,client-api.arkoselabs.com,AI",
        "DOMAIN-SUFFIX,events.statsigapi.net,AI",
        "DOMAIN-SUFFIX,featuregates.org,AI",
        "DOMAIN-SUFFIX,host.livekit.cloud,AI",
        "DOMAIN-SUFFIX,identrust.com,AI",
        "DOMAIN-SUFFIX,intercom.io,AI",
        "DOMAIN-SUFFIX,intercomcdn.com,AI",
        "DOMAIN-SUFFIX,launchdarkly.com,AI",
        "DOMAIN-SUFFIX,oaistatic.com,AI",
        "DOMAIN-SUFFIX,oaiusercontent.com,AI",
        "DOMAIN-SUFFIX,observeit.net,AI",
        "DOMAIN-SUFFIX,openai.com,AI",
        "DOMAIN-SUFFIX,openaiapi-site.azureedge.net,AI",
        "DOMAIN-SUFFIX,openaicom.imgix.net,AI",
        "DOMAIN-SUFFIX,segment.io,AI",
        "DOMAIN-SUFFIX,sentry.io,AI",
        "DOMAIN-SUFFIX,stripe.com,AI",
        "DOMAIN-SUFFIX,turn.livekit.cloud,AI",
        "DOMAIN-KEYWORD,openai,AI",
        // Copilot è§„åˆ™
        "DOMAIN,api.msn.com,AI",
        "DOMAIN,api.statsig.com,AI",
        "DOMAIN,assets.msn.com,AI",
        "DOMAIN,copilot.microsoft.com,AI",
        "DOMAIN,gateway.bingviz.microsoft.net,AI",
        "DOMAIN,gateway.bingviz.microsoftapp.net,AI",
        "DOMAIN,in.appcenter.ms,AI",
        "DOMAIN,location.microsoft.com,AI",
        "DOMAIN,odc.officeapps.live.com,AI",
        "DOMAIN,r.bing.com,AI",
        "DOMAIN,self.events.data.microsoft.com,AI",
        "DOMAIN,services.bingapis.com,AI",
        "DOMAIN,sydney.bing.com,AI",
        "DOMAIN, www.bing.com,AI ",
        "DOMAIN-SUFFIX,api.microsoftapp.net,AI",
        "DOMAIN-SUFFIX,bing-shopping.microsoft-falcon.io,AI",
        "DOMAIN-SUFFIX,challenges.cloudflare.com,AI",
        "DOMAIN-SUFFIX,edgeservices.bing.com,AI",
        "DOMAIN-KEYWORD,openaicom-api,AI",
        // Gemini è§„åˆ™
        "DOMAIN,ai.google.dev,AI",
        "DOMAIN,alkalimakersuite-pa.clients6.google.com,AI",
        "DOMAIN,makersuite.google.com,AI",
        "DOMAIN-SUFFIX,bard.google.com,AI",
        "DOMAIN-SUFFIX,deepmind.com,AI",
        "DOMAIN-SUFFIX,deepmind.google,AI",
        "DOMAIN-SUFFIX,gemini.google.com,AI",
        "DOMAIN-SUFFIX,generativeai.google,AI",
        "DOMAIN-SUFFIX,proactivebackend-pa.googleapis.com,AI",
        "DOMAIN-SUFFIX,apis.google.com,AI",
        "DOMAIN-KEYWORD,colab,AI",
        "DOMAIN-KEYWORD,developerprofiles,AI",
        "DOMAIN-KEYWORD,generativelanguage,AI",
        // Claude è§„åˆ™
        "DOMAIN,cdn.usefathom.com,AI",
        "DOMAIN-SUFFIX,anthropic.com,AI",
        "DOMAIN-SUFFIX,claude.ai,AI",
        // Grok è§„åˆ™
        "DOMAIN-SUFFIX,x.ai,AI",
        "DOMAIN-SUFFIX,grok.com,AI",

        // å¸¸è§æµ·å¤–æœåŠ¡å’Œäº’è”ç½‘å…¬å¸çš„åŸŸå æœ‰éƒ¨åˆ†åŸŸåè¢«DNSæ±¡æŸ“ï¼Œæ•…ä½¿ç”¨ä»£ç†
        "RULE-SET,Global_no_ip," + proxyName,

        // å›½å†…å¸¸è§äº’è”ç½‘å…¬å¸å’ŒæœåŠ¡çš„åŸŸå
        "RULE-SET,Domestic_no_ip,DIRECT",
        "RULE-SET,Direct_no_ip,DIRECT",

        // å†…ç½‘åŸŸåå’Œå±€åŸŸç½‘ IP
        /**
         * åŸŸååˆ—è¡¨åŒ…å« .local å’Œå±€åŸŸç½‘ IP çš„ in-addr.arpa åŸŸåï¼ˆå³ AS112 åŸŸåï¼‰
         * è¿™éƒ¨åˆ†åŸŸåä¸€èˆ¬ä¼šè¢«è§£æžåˆ°å±€åŸŸç½‘ IPã€éœ€è¦èµ°å†…ç½‘ DNS è§£æžã€éœ€è¦ç›´è¿žè®¿é—®
         */
        "RULE-SET,Lan_no_ip,DIRECT",
    ];

    const ipRules = [
        "RULE-SET,GlobalDirect,DIRECT", // æ–°å¢žè§„åˆ™
        // GooleFCM æŽ¨é€
        "RULE-SET,GoogleFCM_ip,GoogleFCM",

        // ç½‘æ˜“äº‘éŸ³ä¹
        "RULE-SET,NetEaseMusic_ip,DIRECT",

        // SteamCN ip
        "RULE-SET,SteamCN_ip,DIRECT",

        // å¹¿å‘Šæ‹¦æˆª / éšç§ä¿æŠ¤ / Malware æ‹¦æˆª / Phiishing æ‹¦æˆªï¼ˆipï¼‰
        "RULE-SET,Reject_ip,REJECT",

        // telegram ip
        "RULE-SET,Telegram_ip,ç”µæŠ¥æ¶ˆæ¯",

        // æµåª’ä½“ ip
        /**
         * åŒ…å«
         * 4gtvã€AbemaTVã€All4ã€Amazon Prime Videoã€Apple TVã€Apple Music TVã€Bahamutã€BBCã€Bilibili Intlã€
         * DAZNã€Deezerã€Disney+ã€Discovery+ã€DMMã€encoreTVBã€Fox Nowã€Fox+ã€HBO GO/Now/Max/Asiaã€Huluã€HWTVã€
         * JOOXã€Jwplayerã€KKBOXã€KKTVã€Line TVã€Naver TVã€myTV Superã€Netflixã€niconicoã€Now Eã€Paramount+ã€PBSã€Peacockã€Pandoraã€PBSã€Pornhubã€SoundCloudã€
         * PBSã€Spotifyã€TaiwanGoodã€Tiktok Intlã€Twitchã€ViuTVã€ShowTimeã€iQiYi Globalã€Himalaya Podcastã€Overcastã€WeTV
         */
        "RULE-SET,Stream_ip,æµåª’ä½“",

        // å›½å†…å¸¸è§äº’è”ç½‘å…¬å¸å’ŒæœåŠ¡çš„ IP
        "RULE-SET,Domestic_ip,DIRECT",
        "RULE-SET,China_ip,DIRECT",

        // å†…ç½‘åŸŸåå’Œå±€åŸŸç½‘ IP
        /**
         * åŸŸååˆ—è¡¨åŒ…å« .local å’Œå±€åŸŸç½‘ IP çš„ in-addr.arpa åŸŸåï¼ˆå³ AS112 åŸŸåï¼‰
         * è¿™éƒ¨åˆ†åŸŸåä¸€èˆ¬ä¼šè¢«è§£æžåˆ°å±€åŸŸç½‘ IPã€éœ€è¦èµ°å†…ç½‘ DNS è§£æžã€éœ€è¦ç›´è¿žè®¿é—®
         */
        "RULE-SET,Lan_ip,DIRECT",
        // ä½¿ç”¨ GEOIP å’Œ GEOSITE å…œåº•ç›´è¿žè§„åˆ™
        "GEOIP,CN,DIRECT",
        "GEOSITE,cn,DIRECT",
        // å…œåº•
        "MATCH,æ¼ç½‘ä¹‹é±¼",
    ];

    const allNonipRules = [...adNonipRules, ...customRules, ...nonipRules];

    // è§„åˆ™
    // éœ€è¦éžIPç±»è§„åˆ™å†™åœ¨ IPç±»è§„åˆ™ä¹‹å‰ï¼
    /**
     * é¿å… DNS æ±¡æŸ“å’Œ DNS æ³„æ¼æœ€æœ‰æ•ˆçš„åŠžæ³•å°±æ˜¯æ°¸è¿œä¸åœ¨æœ¬åœ°è¿›è¡Œ DNS è§£æžï¼Œè€Œ Mihomo èƒ½ä¸”åªèƒ½é€šè¿‡ Fake IP å’ŒåŸŸåè§„åˆ™åŒ¹é…çš„æ–¹å¼ å¯ä»¥å®žçŽ°éžç›´è¿žåŸŸå ä¸€å®šä¸åœ¨æœ¬åœ°æœ¬æœºè¿›è¡Œä»»ä½• DNS è§£æžã€‚
     * åœ¨ Mihomo ä¸­ï¼Œè§„åˆ™è‡ªä¸Šè€Œä¸‹åŒ¹é…ï¼Œåªæœ‰å½“é‡åˆ° IP ç±»è§„åˆ™ï¼ˆå¦‚ IP-CIDRã€IP-CIDR6ã€GEOIP å’Œ IP-ASNï¼‰æ—¶æ‰ä¼šå‘èµ· DNS è§£æžã€‚
     * å› æ­¤ï¼Œåœ¨ Mihomo ä¸­ï¼Œå°†ä¼šè§¦å‘ DNS è§£æžçš„è§„åˆ™æ”¾åœ¨åŸŸåå’Œ URL åŒ¹é…è§„åˆ™åŽé¢éžå¸¸é‡è¦ã€‚
     */
    const rules = [
        // éžipç±»è§„åˆ™
        ...allNonipRules,

        // ipç±»è§„åˆ™
        ...ipRules,
    ];

    // æ’å…¥è§„åˆ™
    params.rules = rules;

    // è¿œç¨‹è§„åˆ™ç±»åž‹
    const ruleAnchor = {
        ip: {
            type: "http",
            interval: 1800,
            behavior: "ipcidr",
            format: "yaml",
        },
        domain: {
            type: "http",
            interval: 1800,
            behavior: "domain",
            format: "yaml",
        },
        classical: {
            type: "http",
            interval: 1800,
            behavior: "classical",
            format: "yaml",
        },
    };

    // è‡ªå·±ä»“åº“çš„è§„åˆ™
    const ruleProviders = {
        /**
         * å±è”½éƒ¨åˆ†
         */

        // ##################################################################################################################

        // å¹¿å‘Šæ‹¦æˆª / éšç§ä¿æŠ¤ / Malware æ‹¦æˆª / Phiishing æ‹¦æˆª
        Reject_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/REJECT/ip/Reject_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/REJECT/ip/Reject_ip.yaml",
        },

        // ##################################################################################################################

        // å¹¿å‘Šæ‹¦æˆª / éšç§ä¿æŠ¤ / Malware æ‹¦æˆª / Phiishing æ‹¦æˆª
        Reject_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/REJECT/no_ip/Reject_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/REJECT/no_ip/Reject_no_ip.yaml",
        },

        Reject_domainset: {
            ...ruleAnchor.domain,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/REJECT/no_ip/Reject_domainset.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/REJECT/no_ip/Reject_domainset.yaml",
        },

        Reject_no_ip_drop: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/REJECT/no_ip/Reject_no_ip_drop.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/REJECT/no_ip/Reject_no_ip_drop.yaml",
        },

        Reject_no_ip_no_drop: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/REJECT/no_ip/Reject_no_ip_no_drop.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/REJECT/no_ip/Reject_no_ip_no_drop.yaml",
        },
        AdobeActivation1: {
            type: "http",
            interval: 1800,
            behavior: "classical",
            format: "yaml",
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/AdobeActivation/AdobeActivation.yaml",
            path: "./ruleset/blackmatrix7/ios_rule_script/AdobeActivation.yaml",
        },
        AdobeActivation2: {
            type: "http",
            interval: 1800,
            behavior: "classical",
            format: "yaml",
            url: "https://raw.githubusercontent.com/ignaciocastro/a-dove-is-dumb/main/clash.yaml",
            path: "./ruleset/ignaciocastro/a-dove-is-dumb/clash.yaml",
        },
        GlobalDirect: {
            type: "http",
            interval: 1800,
            behavior: "classical",
            format: "yaml",
            url: "https://raw.githubusercontent.com/zkmydgth/customize/refs/heads/main/DIRTCT_clash.yaml",
            path: "./ruleset/zkmydgth/DIRTCT_clash.yaml",
        },
        // ##################################################################################################################

        /**
         * ç›´è¿žéƒ¨åˆ†
         */

        // ##################################################################################################################

        // å›½å†…å¸¸è§äº’è”ç½‘å…¬å¸å’ŒæœåŠ¡çš„ IP
        China_ip: {
            ...ruleAnchor.ip,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/ip/China_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/ip/China_ip.yaml",
        },

        // å›½å†…å¸¸è§äº’è”ç½‘å…¬å¸å’ŒæœåŠ¡çš„ IP
        Domestic_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/ip/Domestic_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/ip/Domestic_ip.yaml",
        },

        // GoogleFCM IP
        GoogleFCM_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/ip/GoogleFCM_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/ip/GoogleFCM_ip.yaml",
        },

        // å†…ç½‘åŸŸåå’Œå±€åŸŸç½‘ IP
        Lan_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/ip/Lan_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/ip/Lan_ip.yaml",
        },

        // ç½‘æ˜“äº‘éŸ³ä¹ ip
        NetEaseMusic_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/ip/NetEaseMusic_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/ip/NetEaseMusic_ip.yaml",
        },

        // SteamCN IP
        SteamCN_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/ip/SteamCN_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/ip/SteamCN_ip.yaml",
        },

        // ##################################################################################################################

        // apple CDN äº‘ä¸Šè´µå·ž
        AppleCDN_no_ip: {
            ...ruleAnchor.domain,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/AppleCDN_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/AppleCDN_no_ip.yaml",
        },

        // è‹¹æžœç›´è¿žåŸŸå
        AppleCN_no_ip: {
            ...ruleAnchor.domain,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/AppleCN_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/AppleCN_no_ip.yaml",
        },

        // å›½å†…å¸¸è§äº’è”ç½‘å…¬å¸å’ŒæœåŠ¡çš„åŸŸå
        Direct_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/Direct_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/Direct_no_ip.yaml",
        },

        // å›½å†…å¸¸è§äº’è”ç½‘å…¬å¸å’ŒæœåŠ¡çš„åŸŸå
        Domestic_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/Domestic_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/Domestic_no_ip.yaml",
        },

        // Google Fcm no ip
        GoogleFCM_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/GoogleFCM_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/GoogleFCM_no_ip.yaml",
        },

        // å†…ç½‘åŸŸåå’Œå±€åŸŸç½‘ IP
        Lan_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/Lan_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/Lan_no_ip.yaml",
        },

        // å¾®è½¯ä¸­å›½ CDN
        MicrosoftCDN_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/MicrosoftCDN_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/MicrosoftCDN_no_ip.yaml",
        },

        // ç½‘æ˜“äº‘éŸ³ä¹åŸŸå
        NetEaseMusic_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/NetEaseMusic_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/NetEaseMusic_no_ip.yaml",
        },

        // SteamCN åŸŸå
        SteamCN_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/SteamCN_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/SteamCN_no_ip.yaml",
        },

        // Steam åœ°åŒºåŸŸå
        SteamRegion_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/DIRECT/no_ip/SteamRegion_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/DIRECT/no_ip/SteamRegion_no_ip.yaml",
        },

        // ##################################################################################################################

        /**
         * ä»£ç†éƒ¨åˆ†
         */

        // ##################################################################################################################

        // æµåª’ä½“ IP
        Stream_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/ip/Stream_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/ip/Stream_ip.yaml",
        },

        // telegram ip
        Telegram_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/ip/Telegram_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/ip/Telegram_ip.yaml",
        },

        // ##################################################################################################################

        // ai ç›¸å…³ åŒ…å« OpenAIã€Google Geminiã€Claudeã€Perplexity ç­‰
        AI_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/AI_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/AI_no_ip.yaml",
        },

        // apple
        Apple_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Apple_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Apple_no_ip.yaml",
        },

        // å¸¸éœ€è¦ä»£ç†çš„é™æ€ CDN
        CDN_domainset: {
            ...ruleAnchor.domain,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/CDN_domainset.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/CDN_domainset.yaml",
        },

        // å¸¸éœ€è¦ä»£ç†çš„é™æ€ CDN
        CDN_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/CDN_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/CDN_no_ip.yaml",
        },

        // å­˜æ”¾ç€ä¸ªäººé‡åˆ°éœ€è¦ä»£ç†çš„åŸŸå
        CustomProxy_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/CustomProxy_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/CustomProxy_no_ip.yaml",
        },

        // è½¯ä»¶æ›´æ–°ã€æ“ä½œç³»ç»Ÿç­‰å¤§æ–‡ä»¶ä¸‹è½½
        Download_domainset: {
            ...ruleAnchor.domain,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Download_domainset.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Download_domainset.yaml",
        },

        // è½¯ä»¶æ›´æ–°ã€æ“ä½œç³»ç»Ÿç­‰å¤§æ–‡ä»¶ä¸‹è½½
        Download_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Download_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Download_no_ip.yaml",
        },

        // å¸¸è§æµ·å¤–æœåŠ¡å’Œäº’è”ç½‘å…¬å¸çš„åŸŸå æœ‰éƒ¨åˆ†åŸŸåè¢«DNSæ±¡æŸ“ï¼Œæ•…ä½¿ç”¨ä»£ç†
        Global_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Global_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Global_no_ip.yaml",
        },

        // å¾®è½¯éœ€è¦ä»£ç†çš„åŸŸå
        Microsoft_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Microsoft_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Microsoft_no_ip.yaml",
        },

        // Steam éœ€è¦ä»£ç†çš„åŸŸå
        Steam_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Steam_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Steam_no_ip.yaml",
        },

        // æµåª’ä½“åŸŸå
        Stream_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Stream_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Stream_no_ip.yaml",
        },

        // æµåª’ä½“åŸŸå
        Emby_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Emby_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Emby_no_ip.yaml",
        },

        // telegram åŸŸå
        Telegram_no_ip: {
            ...ruleAnchor.classical,
            url: "https://raw.githubusercontent.com/RealSeek/Clash_Rule_DIY/refs/heads/mihomo/PROXY/no_ip/Telegram_no_ip.yaml",
            path: "./ruleset/RealSeek/Clash_Rule_DIY/PROXY/no_ip/Telegram_no_ip.yaml",
        },

        // ##################################################################################################################
    };

    // æ’å…¥è¿œç¨‹è§„åˆ™
    params["rule-providers"] = ruleProviders;
}

function getProxiesByRegexOne(params, regex) {
    return params.proxies.filter((e) => regex.test(e.name)).map((e) => e.name);
}

function getProxiesByRegex(params, regex) {
    const matchedProxies = params.proxies
        .filter((e) => regex.test(e.name))
        .map((e) => e.name);
    return matchedProxies.length > 0 ? matchedProxies : ["æ‰‹åŠ¨é€‰æ‹©"];
}

// ä¿®æ”¹DNS
function overwriteDns(params) {
    const dnsOptions = {
        enable: true,
        "listen": "0.0.0.0:1053",
        "enhanced-mode": "fake-ip", // fake-ip æˆ– redir-host
        "fake-ip-range": "198.18.0.1/16",
        "use-hosts": false,
        "use-system-hosts": false,
        ipv6: false,

        "fake-ip-filter": [
            "*",
            "+.lan",
            "+.local",
            "time.*.com",
            "ntp.*.com",
            "+.market.xiaomi.com",
            "localhost.ptlogin2.qq.com",
            "localhost.sec.qq.com",
            "+.qq.com",
            "+.tencent.com",
            "+.msftconnecttest.com",
            "+.msftncsi.com",
        ],

        "default-nameserver": [
            "tls://223.5.5.5",
        ],

        nameserver: [
            "https://dns.alidns.com/dns-query",
            "https://doh.pub/dns-query",
        ],

        "proxy-server-nameserver": [
            "https://doh.pub/dns-query",
            "https://dns.alidns.com/dns-query",
        ],
    };

    params["dns"] = dnsOptions;
}

function getManualProxiesByRegex(params, regex) {
    const matchedProxies = params.proxies
        .filter((e) => regex.test(e.name))
        .map((e) => e.name);
    return matchedProxies.length > 0
        ? matchedProxies
        : ["DIRECT", "æ‰‹åŠ¨é€‰æ‹©", proxyName];
}

// è¦†å†™Tunnel
function overwriteTunnel(params) {
    const tunnelOptions = {
        enable: true,
        stack: "mixed",
        device: "Mihomo",
        "dns-hijack": ["any:53"],
        "auto-route": true,
        "auto-redirect": false,
        "auto-detect-interface": true,
        "strict-route": false,
        "route-exclude-address": [],
        mtu: 1500,
    };
    params.tun = { ...tunnelOptions };
}
